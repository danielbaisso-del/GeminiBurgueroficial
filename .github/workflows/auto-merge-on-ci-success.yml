name: Auto-merge PR on CI success

on:
  workflow_run:
    workflows: ["CI â€” Build frontend and Docker image"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Merge associated PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const head = context.payload.workflow_run.head_branch;
            core.info(`Workflow finished successfully for branch: ${head}`);
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${head}`,
              state: 'open',
            });

            if (!prs || prs.length === 0) {
              core.info('No open PR found for branch ' + head);
              return;
            }

            const pr = prs[0];
            core.info(`Found PR #${pr.number} - attempting merge`);

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              merge_method: 'squash',
            });

            core.info(`Merged PR #${pr.number}`);
